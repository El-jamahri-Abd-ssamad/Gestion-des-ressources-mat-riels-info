//dev 1

CREATE TABLE Account (
    Id INT IDENTITY PRIMARY KEY,
    Username VARCHAR(50) UNIQUE NOT NULL,
    Password VARCHAR(255) NOT NULL,
    Role INT NOT NULL
);

CREATE TABLE [User] (
    Id INT IDENTITY PRIMARY KEY,
    Name VARCHAR(100),
    Email VARCHAR(100),
    Phone VARCHAR(20),
    DateBirth DATE,
    IdAccount INT NOT NULL,
    CONSTRAINT FK_User_Account
        FOREIGN KEY (IdAccount) REFERENCES Account(Id)
);

CREATE TABLE [dbo].[Departement] (
    [Id] INT IDENTITY(1,1) NOT NULL,
    [Nom] VARCHAR(100) NOT NULL,
    [Budget] DECIMAL(18,2) NOT NULL,
    [ChefId] INT NOT NULL,  -- référence Account.Id
    PRIMARY KEY CLUSTERED ([Id] ASC),
    CONSTRAINT [FK_Departement_Chef] FOREIGN KEY ([ChefId]) REFERENCES [dbo].[Account]([Id])
);

CREATE TABLE [dbo].[Besoin] (
    [Code] INT IDENTITY(1,1) NOT NULL,
    [DepartementId] INT NOT NULL,
    [DateSoumission] DATETIME NOT NULL,
    [TypeRessource] VARCHAR(50) NOT NULL,  -- Ordinateur / Imprimante
    [Description] VARCHAR(255) NOT NULL,
    [Quantite] INT NOT NULL,
    [ValideParChef] BIT NOT NULL DEFAULT 0,
    PRIMARY KEY CLUSTERED ([Code] ASC),
    CONSTRAINT [FK_Besoin_Departement] FOREIGN KEY ([DepartementId]) REFERENCES [dbo].[Departement]([Id])
);

//dev3

CREATE TABLE Tender (
    Id INT IDENTITY PRIMARY KEY,
    Title VARCHAR(150) NOT NULL,
    Description TEXT,
    StartDate DATE NOT NULL,
    EndDate DATE NOT NULL,
    Status VARCHAR(20) NOT NULL,
    CreatedBy INT NOT NULL,

    CONSTRAINT FK_Tender_User
        FOREIGN KEY (CreatedBy) REFERENCES [User](Id)
);

CREATE TABLE TenderItem (
    Id INT IDENTITY PRIMARY KEY,
    IdTender INT NOT NULL,
    Label VARCHAR(100) NOT NULL,
    Quantity INT NOT NULL,

    CONSTRAINT FK_TenderItem_Tender
        FOREIGN KEY (IdTender) REFERENCES Tender(Id)
        ON DELETE CASCADE
);

CREATE TABLE Supplier (
    Id INT IDENTITY PRIMARY KEY,
    IdUser INT NOT NULL UNIQUE,
    CompanyName VARCHAR(150) NOT NULL,
    IsBlacklisted BIT DEFAULT 0,
    BlacklistReason VARCHAR(255),

    CONSTRAINT FK_Supplier_User
        FOREIGN KEY (IdUser) REFERENCES [User](Id)
);
CREATE TABLE Offer (
    Id INT IDENTITY PRIMARY KEY,
    IdTender INT NOT NULL,
    IdSupplier INT NOT NULL,
    TotalPrice DECIMAL(12,2) NOT NULL,
    WarrantyMonths INT NOT NULL,
    Status VARCHAR(20) NOT NULL,
    SubmissionDate DATETIME NOT NULL,

    CONSTRAINT FK_Offer_Tender
        FOREIGN KEY (IdTender) REFERENCES Tender(Id),

    CONSTRAINT FK_Offer_Supplier
        FOREIGN KEY (IdSupplier) REFERENCES Supplier(Id)
);

CREATE TABLE OfferItem (
    Id INT IDENTITY PRIMARY KEY,
    IdOffer INT NOT NULL,
    IdTenderItem INT NOT NULL,
    UnitPrice DECIMAL(10,2) NOT NULL,
    Quantity INT NOT NULL,

    CONSTRAINT FK_OfferItem_Offer
        FOREIGN KEY (IdOffer) REFERENCES Offer(Id)
        ON DELETE CASCADE,

    CONSTRAINT FK_OfferItem_TenderItem
        FOREIGN KEY (IdTenderItem) REFERENCES TenderItem(Id)
);

CREATE TABLE BlacklistEntry (
    Id INT IDENTITY PRIMARY KEY,
    IdSupplier INT NOT NULL,
    Date DATETIME NOT NULL,
    Reason VARCHAR(255) NOT NULL,
    CreatedBy INT NOT NULL,

    CONSTRAINT FK_Blacklist_Supplier
        FOREIGN KEY (IdSupplier) REFERENCES Supplier(Id),

    CONSTRAINT FK_Blacklist_User
        FOREIGN KEY (CreatedBy) REFERENCES [User](Id)
);

CREATE INDEX IDX_Tender_Status ON Tender(Status);
CREATE INDEX IDX_Offer_Tender ON Offer(IdTender);
CREATE INDEX IDX_Offer_Supplier ON Offer(IdSupplier);
CREATE INDEX IDX_Supplier_User ON Supplier(IdUser);
